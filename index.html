<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clj-chess</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            grid-template-rows: repeat(8, 60px);
            border: 2px solid #333;
            margin: 20px 0;
        }

        .square {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            cursor: pointer;
        }

        .light {
            background-color: #f0d9b5;
        }

        .dark {
            background-color: #b58863;
        }

        .square:hover {
            opacity: 0.8;
        }

        .selected {
            box-shadow: inset 0 0 0 3px #FFD700;
        }

        .legal-move {
            box-shadow: inset 0 0 0 3px #00FF00;
        }

        .controls {
            margin: 20px 0;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .status {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>clj-chess</h1>
    
    <div class="controls">
        <button id="newGameBtn">New Game</button>
    </div>
    
    <div id="status" class="status">Disconnected</div>
    
    <div id="chessBoard" class="chess-board"></div>

    <script>
        let socket;
        let currentBoard = null;
        let gameState = null;
        let selectedSquare = null;
        let selectedPieceId = null;

        // Chess piece Unicode symbols
        const pieceSymbols = {
            'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚', 'p': '♟',
            'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔', 'P': '♙'
        };

        function connectWebSocket() {
            token = '?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxMjM0NX0.6L5S6cep1mtknTIxHzxU_70k-wRC5EkuAl5B0sKLtdc';
            // socket = new WebSocket('ws://localhost:8080'+token);
            socket = new WebSocket('ws://clj-chess.railway.internal'+token);
            
            socket.onopen = function(event) {
                console.log('Connected to WebSocket');
                document.getElementById('status').textContent = 'Connected to server';
            };
            
            socket.onmessage = function(event) {
                console.log('Message received:', event.data);
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === 'game') {
                        handleGameMessage(message);
                    }
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
            
            socket.onclose = function(event) {
                console.log('WebSocket connection closed');
                document.getElementById('status').textContent = 'Disconnected from server';
                localStorage.removeItem('gameState');
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                document.getElementById('status').textContent = 'Connection error';
            };
        }

        function handleGameMessage(message) {
            if (message.payload && message.payload.board) {
                currentBoard = message.payload.board;
                gameState = message.payload;
                
                // Store game state in localStorage
                localStorage.setItem('gameState', JSON.stringify(gameState));
                
                renderBoard(currentBoard);
                
                // Update status with game info
                const payload = message.payload;
                const statusText = `Player turn: ${payload.player_turn + 1}`;
                document.getElementById('status').textContent = statusText;
            }
        }

        function renderBoard(board) {
            const boardElement = document.getElementById('chessBoard');
            boardElement.innerHTML = '';
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = document.createElement('div');
                    square.className = 'square';
                    
                    // Alternate colors
                    if ((row + col) % 2 === 0) {
                        square.classList.add('light');
                    } else {
                        square.classList.add('dark');
                    }
                    
                    // Add piece if exists
                    const piece = board[row][col];
                    if (piece && piece[0] !== null && piece[1] !== null) {
                        const [playerId, pieceType, pieceId] = piece;
                        
                        // Convert to appropriate symbol based on player
                        let symbol;
                        if (playerId === 0) {
                            // White pieces (uppercase)
                            symbol = pieceSymbols[pieceType.toUpperCase()];
                        } else {
                            // Black pieces (lowercase)
                            symbol = pieceSymbols[pieceType.toLowerCase()];
                        }
                        
                        square.textContent = symbol || pieceType;
                    }
                    
                    // Store position data
                    square.dataset.row = row;
                    square.dataset.col = col;
                    if (piece && piece[0] !== null && piece[1] !== null) {
                        square.dataset.pieceId = piece[2];
                    }
                    
                    // Add click handler for piece selection and moves
                    square.addEventListener('click', function() {
                        handleSquareClick(row, col, piece);
                    });
                    
                    boardElement.appendChild(square);
                }
            }
        }

        function handleSquareClick(row, col, piece) {
            // Clear all highlights
            clearHighlights();
            
            // If clicking on a piece with legal moves
            if (piece && piece[0] !== null && piece[1] !== null) {
                const pieceId = piece[2];
                selectedSquare = [row, col];
                selectedPieceId = pieceId;
                
                // Highlight selected square
                const square = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                square.classList.add('selected');
                
                // Show legal moves if available
                showLegalMoves(row, col);
            } else {
                // Clear selection
                selectedSquare = null;
                selectedPieceId = null;
            }
        }

        function showLegalMoves(row, col) {
            if (!gameState || !gameState.legal_moves) {
                return;
            }
           
            // Find legal moves for this piece
            for (const move of gameState.legal_moves) {
                if (move[0][0] == row && move[0][1] == col) {
                    const legalMoves = move[1];
                    
                    // Highlight all legal move squares
                    legalMoves.forEach(movePos => {
                        const [targetRow, targetCol] = movePos;
                        const targetSquare = document.querySelector(`[data-row="${targetRow}"][data-col="${targetCol}"]`);
                        if (targetSquare) {
                            targetSquare.classList.add('legal-move');
                            targetSquare.addEventListener('click', function() {
                                movePiece([row, col], [targetRow, targetCol]);
                            });
                        }
                    });
                    break;
                }
            }
        }

        function movePiece(from, to) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'game',
                    payload: {
                        action: 'move',
                        gs: gameState,
                        player_index: 0,
                        args: {
                            step: [from, to]
                        }
                    }
                };
                socket.send(JSON.stringify(message));
            } else {
                console.error('WebSocket is not connected');
                document.getElementById('status').textContent = 'Not connected to server';
            } 
        }

        function clearHighlights() {
            document.querySelectorAll('.selected').forEach(square => {
                square.classList.remove('selected');
            });
            document.querySelectorAll('.legal-move').forEach(square => {
                square.classList.remove('legal-move');
            });
        }

        function loadGameStateFromStorage() {
            const stored = localStorage.getItem('gameState');
            if (stored) {
                try {
                    gameState = JSON.parse(stored);
                    if (gameState && gameState.board) {
                        currentBoard = gameState.board;
                        renderBoard(currentBoard);
                        
                        // Update status
                        const statusText = `Player turn: ${gameState.player_turn + 1} | Moves: ${gameState.moves_count} | Scores: ${gameState.overall_scores.join('-')}`;
                        document.getElementById('status').textContent = statusText + ' (Loaded from storage)';
                    }
                } catch (error) {
                    console.error('Error loading game state from storage:', error);
                }
            }
        }

        function sendNewGame() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'game',
                    payload: {
                        action: 'new_game'
                    }
                };
                socket.send(JSON.stringify(message));
                console.log('New game message sent');
            } else {
                console.error('WebSocket is not connected');
                document.getElementById('status').textContent = 'Not connected to server';
            }
        }

        // Event listeners
        document.getElementById('newGameBtn').addEventListener('click', sendNewGame);

        // Connect on page load
        window.addEventListener('load', function() {
            // Load game state from storage first
            loadGameStateFromStorage();
            connectWebSocket();
        });
    </script>
</body>
</html>